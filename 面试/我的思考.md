### 消息队列如何保证消息不丢失
一般在**生产阶段、存储阶段、消费阶段**保证消息可靠性

##### **发送消息的时候保证消息正确保存到消息队列**

- 同步发送消息注意处理失败和异常，失败重试
- 异步发送需要处理消息发送回调，失败重试
- 若发送超时，需要在查看日志，检查消息是否发送成功

##### 存储

- 消息持久化到CommitLog日志中，若消息队列宕机，可以恢复未消费的消息
- 通过broke的刷盘机制，将消息存到磁盘中，有同步刷盘和异步刷盘两种，同步刷盘更可靠，它是等数据存到磁盘中再返回，但会牺牲性能
- broke通过主从模式保证高可用

##### 消费者保证消息被消费

在业务层面，消费者完成消息数据的全部业务逻辑处理后再返回消费确认，在消息队列中维护了消息的位置，逻辑执行失败，没有确认，再去拉取消息还是原来的

### 如何处理重复消费问题

主要由业务层面自己保证，主要有**业务幂等**和**消息去重**两种方式

**业务幂等**：消息重复消费对业务没有影响，多次消费结果一样

**消息去重**：通过消息数据的唯一ID判断消息是否处理过，一般为业务关联的，如订单号，满意度NO，预约号
